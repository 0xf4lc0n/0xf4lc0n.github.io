<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>Virtualization</title><meta content=Virtualization name=title><meta content=Falcon name=author><meta content=website property=og:type><meta content=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/ property=og:url><meta property=og:site_name><meta content=Virtualization property=og:title><meta content=https://0xf4lc0n.github.io/favicon.ico property=og:image><link href=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/ rel=canonical><link rel="shortcut icon" href=https://0xf4lc0n.github.io/favicon.ico type=image/x-icon><link href=https://0xf4lc0n.github.io/atom.xml rel=alternate title=RSS type=application/atom+xml><link href=https://0xf4lc0n.github.io/css/style.css rel=stylesheet><script defer src=https://0xf4lc0n.github.io/js/script.js></script><body><div class=wrapper><header><nav class=navBar><a href=/> /home/ </a><a href=/blog> /blog/ </a><a href=/about> /about/ </a><div class=themeSwitch><button class="themeButton dark" onclick="setTheme('dark')" title="Dark mode"><svg class="icons icons__background"><use href=https://0xf4lc0n.github.io/icons.svg#darkMode></use></svg></button><button class="themeButton light" onclick="setTheme('light')" title="Light mode"><svg class="icons icons__background"><use href=https://0xf4lc0n.github.io/icons.svg#lightMode></use></svg></button></div></nav></header><main><h1>Virtualization</h1><p>First I prepared safe environment where I was able to conduct analysis. I used Virtualbox in order to create virtual machines and install necersary software.<p>Virtualbox can be downloaded from this site:<p><a href=https://www.virtualbox.org/ rel=noopener target=_blank>VirtualBox</a><p>Additionaly I installed “VirtualBox Extension Pack” which allowed me to use some feautures.<p>As my main system I chose Windows 10 Home 64-bit with latest updates. You can find it here:<p><a href=https://www.microsoft.com/pl-pl/software-download/windows10ISO rel=noopener target=_blank>Windows 10</a><p>Having choosen the system, I created virtual machine and installed system on it. I think that the process is so intuitive that it doesn’t require any explanation.<p>After installation of the system I created a snapshot because if the system gets damaged, I can easily restore it.<p>To do that you have to expand context menu and choose “Snapshots”.<p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/Snap1.png><p>Then click “Take”.<p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/Snap2.png><p>In that window you can provide a name and comment for your snapshot.<p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/Snap3.png><p>If everything is correct, you should see your named snapshot.<p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/Snap4.png><h3 id=software-installation>Software installation</h3><p>When virtual machine was ready and “snapshoted” I provided access to the Internet and downloaded folowing programs:<ul><li><a href=https://www.hex-rays.com/products/ida/support/download_freeware/ rel=noopener target=_blank>IDA Free</a> or <a href=https://ghidra-sre.org/ rel=noopener target=_blank>Ghidra</a><li><a href=https://x64dbg.com/ rel=noopener target=_blank>x64dbg</a><li><a href=http://wjradburn.com/software/ rel=noopener target=_blank>PE View</a><li><a href=https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite rel=noopener target=_blank>Sysinternals Suite</a><li><a href=https://mh-nexus.de/en/hxd/ rel=noopener target=_blank>HxD Hex Editor</a><li><a href=https://github.com/decalage2/oletools/wiki/olevba rel=noopener target=_blank>olevba</a><li><a href=https://blog.didierstevens.com/programs/oledump-py/ rel=noopener target=_blank>oledump</a><li><a href=https://www.wireshark.org/ rel=noopener target=_blank>Wireshark</a></ul><p>I also omitted the process of installation because it’s quite easy. In most cases you have to left default values and click “Next”. Ghidra has a more complex installation because you have to provide JDK 11 and modify your PATH. Don’t worry though Ghidra’s manual extexts how to do that.<p>After software installation I changed network adapter from “Briged Adapter” to “Internal Network”.<h3 id=a-listening-machine>A listening machine</h3><p>Because my main machine worked in isolated network I also created second machine in order to capture network traffic from the isolated one. I decided to use Kali Linux because it has pre installed all the tools which I wanted to use.<p><a href=https://www.kali.org/downloads/ rel=noopener target=_blank>Kali Linux</a><p>Note here that you can download ISO or OVA file which can be imported to VirtualBox and by this process of system installation can be omitted.<p>If you decide to choose another Linux distrubition, you have to manually install:<ul><li>Wireshark<li>INetSim<li>Burp Suite</ul><p>Additionaly I installed tools to analyse OLE2 files (oletools and oledump).<p>For the good start:<pre class=language-bash data-lang=bash style=background:#282828;color:#fdf4c1aa><code class=language-bash data-lang=bash><span style=color:#fdf4c1>apt update
</span><span style=color:#fdf4c1>apt upgrade
</span></code></pre><p>Now it’s time for python packet manager:<pre class=language-bash data-lang=bash style=background:#282828;color:#fdf4c1aa><code class=language-bash data-lang=bash><span style=color:#fdf4c1>apt install python-pip
</span></code></pre><p>Then oletools:<pre class=language-bash data-lang=bash style=background:#282828;color:#fdf4c1aa><code class=language-bash data-lang=bash><span style=color:#fdf4c1>pip install oletools
</span></code></pre><p>And oledump:<pre class=language-bash data-lang=bash style=background:#282828;color:#fdf4c1aa><code class=language-bash data-lang=bash><span style=color:#fdf4c1>wget https://didierstevens.com/files/software/oledump_V0_0_44.zip                      
</span><span style=color:#fdf4c1>unzip oledump_V0_0_44 -d oledump
</span></code></pre><p>At the end I also changed network adapter from “Briged Adapter” to “Internal Network”.<h3 id=software-configuration-and-addressing-of-the-systems>Software configuration and addressing of the systems</h3><p>To provide proper packet flow it requires a valid addressation. I edited /etc/network/interfaces file by adding following content:<pre class=language-txt data-lang=txt style=background:#282828;color:#fdf4c1aa><code class=language-txt data-lang=txt><span>auto eh0 iface 
</span><span>eth0 inet static 
</span><span>  address 10.10.10.1 
</span><span>  netmask 255.255.255.0
</span></code></pre><p>Then I started interface:<pre class=language-bash data-lang=bash style=background:#282828;color:#fdf4c1aa><code class=language-bash data-lang=bash><span style=color:#fdf4c1>ifup eth0
</span></code></pre><p>Here it is very important to correctly identify network interfaces if you want to check how your network interfaces were marked use:<pre class=language-bash data-lang=bash style=background:#282828;color:#fdf4c1aa><code class=language-bash data-lang=bash><span style=color:#fdf4c1>ip -c a
</span></code></pre><p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/interfaces.png><p>You should see two interfaces (if you set only one network adapter). One of them is loopback marked as “lo”. The secod one however, is the one which you want to configure. In my case it was eth0. Next I configured software. Firstly I chose INetSim. I created directory to store configuration and output files.<pre class=language-bash data-lang=bash style=background:#282828;color:#fdf4c1aa><code class=language-bash data-lang=bash><span style=color:#fdf4c1>mkdir malware-analysis
</span></code></pre><p>Directory fo INetSim configuration:<pre class=language-bash data-lang=bash style=background:#282828;color:#fdf4c1aa><code class=language-bash data-lang=bash><span style=color:#fdf4c1>mkdir inetsim-ma
</span></code></pre><p>Then I copied configuration files:<pre class=language-bash data-lang=bash style=background:#282828;color:#fdf4c1aa><code class=language-bash data-lang=bash><span style=color:#fdf4c1>cp /etc/inetsim/inetsim.conf malware-analysis/inetsim-ma/
</span><span style=color:#fdf4c1>cp -r /var/lib/inetsim malware-analysis/inetsim-ma/data
</span><span style=color:#fabd2f>cd</span><span style=color:#fdf4c1> malware-analysis/inetsim-ma/
</span><span style=color:#fdf4c1>chmod -R 777 data/
</span></code></pre><p>And edited inetsim.conf:<pre class=language-bash data-lang=bash style=background:#282828;color:#fdf4c1aa><code class=language-bash data-lang=bash><span style=font-style:italic;color:#928374>#service_bind_address 10.10.10.1
</span><span style=color:#fdf4c1>service_bind_address 0.0.0.0
</span><span>
</span><span style=font-style:italic;color:#928374>#dns_default_ip 10.10.10.1
</span><span style=color:#fdf4c1>dns_default_ip 10.10.10.1
</span><span>
</span><span style=font-style:italic;color:#928374>#https_bind_port 443
</span><span style=color:#fdf4c1>https_bind_port 8443
</span></code></pre><p>After that I launched INetSim:<pre class=language-bash data-lang=bash style=background:#282828;color:#fdf4c1aa><code class=language-bash data-lang=bash><span style=color:#fdf4c1>inetsim –data data/ --conf inetsim.conf
</span></code></pre><p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/inetsim_test.png><p>Next it was time for Burp Suite. I started it and clicked Proxy -> Options.<p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/bsuite_c1.png><p>Then I edited existing listener by selecting it and clicking “Edit”.<ul><li>In Binding: <ul><li>Bind to port: 443<li>Bind to address: all interfaces</ul><li>In Request handling: <ul><li>Redirect to host: localhost<li>Redirect to port: 8443<li>Select an option Support invisible proxying</ul></ul><p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/bsuite_c2.png><p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/bsuite_c3.png><p>I added one aditional listener in order to download Burp’s CA on Windows machine.<ul><li>In Binding <ul><li>Bind to port: 8080<li>Bind to adress: All interfaces</ul></ul><p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/bsuite_c4.png><p>My final settings:<p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/bsuite_c6.png><p>At the end I disabled interception. Proxy -> Intercept -> Intercept is off<p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/bsuite_c5.png><p>On Windows I configured network interface.<p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/windows_ip.png><p>I deactivated Windows Defender and firewall.<p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/windows_firewall.png><p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/windows_def1.png><p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/windows_def2.png><p>And I checked my network by using ping.<p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/windows_ping.png><p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/linux_ping.png><p>I also checked INetSim by providing any valid url.<p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/inetsim_site.png><p>At the end of this process I installed Burp CA on Windows. I started browser and went to 10.10.10.1:8080.<p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/burp_ca.png><p>I clicked in “CA Certificate”, saved certificate on my disc and opened it by double clicking.<p>Install certificate → Local computer → Next→ Certificate’s storage: Trusted CA → Next → End.<p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/win_ca1.png><p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/win_ca2.png><p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/win_ca3.png><p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/win_ca4.png><p>After proper installation you should see that page for all https sites.<p><img alt src=https://0xf4lc0n.github.io/blog/first-steps-in-re/environment-configuration/img/win_ca_installed.png><p>Finally it’s time for main part of analysis!<h4 id=table-of-content>Table of content:</h4><ol><li><a href=/blog/first-steps-in-re/environment-configuration>Environment configuration</a><li><a href=/blog/first-steps-in-re/initial-analysis>Initial analysis</a><li><a href=/blog/first-steps-in-re/macro-analysis>Macro analysis</a><li><a href=/blog/first-steps-in-re/dropper-analysis>Dropper analysis</a><li><a href=/blog/first-steps-in-re/detonation>Detonation</a><li><a href=/blog/first-steps-in-re/domain-analysis>Domain analysis</a><li><a href=/blog/first-steps-in-re/detonation-v2>Detonation ver. 2</a><li><a href=/blog/first-steps-in-re/summary>Summary</a></ol><p class=tagsData></main><footer><hr><div class=footContainer><div class=footLeft><p>Licensed under <a rel="noopener noreferrer" href=https://fr.wikipedia.org/wiki/Licence_MIT target=_blank>MIT</a><br> Built with <a rel="noopener noreferrer" href=https://www.getzola.org target=_blank>Zola</a> using <a rel="noopener noreferrer" href=https://github.com/Speyll/anemone target=_blank>anemone</a> theme & <a rel="noopener noreferrer" href=https://github.com/Speyll/veqev target=_blank>veqev</a> colors.<br></div><div class=footRight><a rel="noopener noreferrer" title="Subscribe via RSS for updates." class=icons__background href=https://0xf4lc0n.github.io/atom.xml target=_blank><svg class="icons icons__background"><use href=https://0xf4lc0n.github.io/icons.svg#rss></use></svg></a></div></div></footer></div>